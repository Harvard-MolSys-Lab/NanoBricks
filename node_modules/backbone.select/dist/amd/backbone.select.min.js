// Backbone.Select, v1.2.7
// Copyright (c) 2014 Michael Heim
//           (c) 2013 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
// http://github.com/hashchange/backbone.select


!function(a,b){if("object"==typeof exports){var c=require("underscore"),d=require("backbone");module.exports=b(c,d)}else"function"==typeof define&&define.amd&&define(["underscore","backbone"],b)}(this,function(_,Backbone){"option strict";return function(Backbone,_){function a(a,b){f(a,b),a.selected&&b.select(a,{_silentReselect:!0,_externalEvent:"add"})}function b(a,b,d){c(a,b,_.extend({},d,{_externalEvent:"remove"}))}function c(a,b,c){a._pickyCollections&&(a._pickyCollections=_.without(a._pickyCollections,b._pickyCid)),a.selected&&(a._pickyCollections&&0===a._pickyCollections.length?b.deselect(a,c):b.deselect(a,_.extend({},c,{_skipModelCall:!0})))}function d(a,b){var d,e,g=_.find(b.previousModels,function(a){return a.selected});g&&c(g,a,{_silentLocally:!0}),_.each(b.previousModels,function(b){b._pickyCollections&&(b._pickyCollections=_.without(b._pickyCollections,a._pickyCid))}),a.each(function(b){f(b,a)}),d=a.filter(function(a){return a.selected}),e=_.initial(d),e.length&&_.each(e,function(a){a.deselect()}),d.length&&a.select(_.last(d),{silent:!0})}function e(a,b){var d,e=_.filter(b.previousModels,function(a){return a.selected});e&&_.each(e,function(b){c(b,a,{_silentLocally:!0})}),_.each(b.previousModels,function(b){b._pickyCollections&&(b._pickyCollections=_.without(b._pickyCollections,a._pickyCid))}),a.each(function(b){f(b,a)}),d=a.filter(function(a){return a.selected}),d.length&&_.each(d,function(b){a.select(b,{silent:!0})})}function f(a,b){a._pickyCollections||(a._pickyCollections=[]),a._pickyCollections.push(b._pickyCid)}function g(a){a.each(function(b){c(b,a,{_silentLocally:!0})})}function h(a){return _.omit(a,"_silentLocally","_externalEvent")}function i(a){return _.omit(a,"_silentLocally","_silentReselect","_skipModelCall","_processedBy","_eventQueue","_eventQueueAppendOnly")}function j(a){function b(a,b){c[b]=a}var c=[];return _.each(a,b),c}function k(a){return a||(a={}),a._processedBy||(a._processedBy={}),a._eventQueue||(a._eventQueue=[]),a}function l(a,b,c){var d=a._eventQueueAppendOnly||a._eventQueue;d.push({actor:b,triggerArgs:c})}function m(a){var b,c;if(a._eventQueue.length&&(b=_.every(a._processedBy,function(a){return a.done})))for(n(a._eventQueue);a._eventQueue.length;)c=a._eventQueue.pop(),c.actor.trigger.apply(c.actor,c.triggerArgs)}function n(a){var b={};_.each(a,function(a,c){var d,e,f,g=a.actor,h=a.triggerArgs[0];"Backbone.Select.Many"===g._pickyType&&"reselect:any"!==h&&(d=b[g._pickyCid],d||(d=b[g._pickyCid]={actor:g,indexes:[],merged:{selected:[],deselected:[],options:{}}}),d.indexes.push(c),e=a.triggerArgs[1],f=a.triggerArgs[3],d.merged.selected=d.merged.selected.concat(e.selected),d.merged.deselected=d.merged.deselected.concat(e.deselected),_.extend(d.merged.options,f))}),b=_.filter(b,function(a){return a.indexes.length>1});var c=_.flatten(_.pluck(b,"indexes"));c.sort(function(a,b){return a-b}),_.each(c,function(b,c){a.splice(b-c,1)}),_.each(b,function(b){a.push({actor:b.actor,triggerArgs:["select:some",{selected:b.merged.selected,deselected:b.merged.deselected},b.actor,b.merged.options]})})}function o(a,b){b.select=function(){var c=b.select;return function(d){return d instanceof Backbone.Model?c.apply(b,arguments):a.apply(b,arguments)}}()}function p(a){a.trigger=function(){var b=a.trigger;return function(a){if(q(a)){var c=s(a),d="on"+c.replace(/(^|:)(\w)/gi,r),e=this[d];_.isFunction(e)&&e.apply(this,_.tail(arguments))}return b.apply(this,arguments),this}}()}function q(a){return/^([rd]e)?select(ed)?($|:)/.test(a)}function r(a,b,c){return c.toUpperCase()}function s(a){return"ed"===a.slice(-2)?a=a.slice(0,-2):(":one"===a.slice(-4)||":any"===a.slice(-4))&&(a=a.slice(0,-4)),a}var t={};t.One=function(){},_.extend(t.One.prototype,{_pickyType:"Backbone.Select.One",select:function(a,b){var c=a&&this.selected===a?a:void 0;b=k(b),b._processedBy[this._pickyCid]||(c||(this.deselect(void 0,_.extend(_.omit(b,"_silentLocally","_processedBy","_eventQueue"),{_eventQueueAppendOnly:b._eventQueue})),this.selected=a),b._processedBy[this._pickyCid]={done:!1},b._processedBy[this.selected.cid]||this.selected.select(h(b)),b.silent||b._silentLocally||(c?b._silentReselect||l(b,this,["reselect:one",a,this,i(b)]):l(b,this,["select:one",a,this,i(b)])),b._processedBy[this._pickyCid].done=!0,m(b))},deselect:function(a,b){b=k(b),b._processedBy[this._pickyCid]||this.selected&&(a=a||this.selected,this.selected===a&&(b._processedBy[this._pickyCid]={done:!1},delete this.selected,b._skipModelCall||a.deselect(h(b)),b.silent||b._silentLocally||l(b,this,["deselect:one",a,this,i(b)]),b._processedBy[this._pickyCid].done=!0,m(b)))},close:function(){g(this),this.stopListening()}}),t.Many=function(){},_.extend(t.Many.prototype,{_pickyType:"Backbone.Select.Many",select:function(a,b){var c=j(this.selected),d=this.selected[a.cid]?[a]:[];b=k(b),d.length&&b._processedBy[this._pickyCid]||(d.length||(this.selected[a.cid]=a,this.selectedLength=_.size(this.selected)),b._processedBy[this._pickyCid]={done:!1},b._processedBy[a.cid]||a.select(h(b)),u(this,c,b,d),b._processedBy[this._pickyCid].done=!0,m(b))},deselect:function(a,b){var c=j(this.selected);b=k(b),b._processedBy[this._pickyCid]||this.selected[a.cid]&&(b._processedBy[this._pickyCid]={done:!1},delete this.selected[a.cid],this.selectedLength=_.size(this.selected),b._skipModelCall||a.deselect(h(b)),u(this,c,b),b._processedBy[this._pickyCid].done=!0,m(b))},selectAll:function(a){var b=j(this.selected),c=[];a||(a={}),this.selectedLength=0,this.each(function(b){this.selectedLength++,this.selected[b.cid]&&c.push(b),this.select(b,_.extend({},a,{_silentLocally:!0}))},this),a=k(a),u(this,b,a,c),a._processedBy[this._pickyCid]?a._processedBy[this._pickyCid].done=!0:a._processedBy[this._pickyCid]={done:!0},m(a)},deselectAll:function(a){var b;0!==this.selectedLength&&(b=j(this.selected),a||(a={}),this.each(function(b){b.selected&&this.selectedLength--,this.deselect(b,_.extend({},a,{_silentLocally:!0}))},this),this.selectedLength=0,a=k(a),u(this,b,a),a._processedBy[this._pickyCid]?a._processedBy[this._pickyCid].done=!0:a._processedBy[this._pickyCid]={done:!0},m(a))},selectNone:function(a){this.deselectAll(a)},toggleSelectAll:function(a){this.selectedLength===this.length?this.deselectAll(a):this.selectAll(a)},close:function(){g(this),this.stopListening()}}),t.Me=function(){},_.extend(t.Me.prototype,{_pickyType:"Backbone.Select.Me",select:function(a){var b=this.selected;a=k(a),a._processedBy[this.cid]||(a._processedBy[this.cid]={done:!1},this.selected=!0,this._pickyCollections?this.trigger("_selected",this,h(a)):this.collection&&(a._processedBy[this.collection._pickyCid]||this.collection.select(this,h(a))),a.silent||a._silentLocally||(b?a._silentReselect||l(a,this,["reselected",this,i(a)]):l(a,this,["selected",this,i(a)])),a._processedBy[this.cid].done=!0,m(a))},deselect:function(a){a=k(a),a._processedBy[this.cid]||this.selected&&(a._processedBy[this.cid]={done:!1},this.selected=!1,this._pickyCollections?this.trigger("_deselected",this,h(a)):this.collection&&this.collection.deselect(this,h(a)),a.silent||a._silentLocally||l(a,this,["deselected",this,i(a)]),a._processedBy[this.cid].done=!0,m(a))},toggleSelected:function(a){this.selected?this.deselect(a):this.select(a)}}),t.Me.applyTo=function(a){if(!_.isObject(a))throw new Error("The host object is undefined or not an object.");_.extend(a,new Backbone.Select.Me),p(a)},t.One.applyTo=function(c,e,g){var h;if(!_.isObject(c))throw new Error("The host object is undefined or not an object.");if(arguments.length<2)throw new Error("The `models` parameter has not been passed to Select.One.applyTo. Its value can be undefined if no models are passed in during instantiation, but even so, it must be provided.");if(!(_.isArray(e)||_.isUndefined(e)||_.isNull(e)))throw new Error("The `models` parameter is not of the correct type. It must be either an array of models, or be undefined. (Null is acceptable, too).");h=c.select,_.extend(c,new Backbone.Select.One),c._pickyCid=_.uniqueId("singleSelect"),p(c),o(h,c),g&&g.enableModelSharing&&(_.each(e||[],function(a){f(a,c),a.selected&&(c.selected&&c.selected.deselect(),c.selected=a)}),c.listenTo(c,"_selected",c.select),c.listenTo(c,"_deselected",c.deselect),c.listenTo(c,"reset",d),c.listenTo(c,"add",a),c.listenTo(c,"remove",b),c._modelSharingEnabled=!0)},t.Many.applyTo=function(c,d,g){var h;if(!_.isObject(c))throw new Error("The host object is undefined or not an object.");if(arguments.length<2)throw new Error("The `models` parameter has not been passed to Select.One.applyTo. Its value can be undefined if no models are passed in during instantiation, but even so, it must be provided.");if(!(_.isArray(d)||_.isUndefined(d)||_.isNull(d)))throw new Error("The `models` parameter is not of the correct type. It must be either an array of models, or be undefined. (Null is acceptable, too).");h=c.select,_.extend(c,new Backbone.Select.Many),c._pickyCid=_.uniqueId("multiSelect"),c.selected={},p(c),o(h,c),g&&g.enableModelSharing&&(_.each(d||[],function(a){f(a,c),a.selected&&(c.selected[a.cid]=a)}),c.listenTo(c,"_selected",c.select),c.listenTo(c,"_deselected",c.deselect),c.listenTo(c,"reset",e),c.listenTo(c,"add",a),c.listenTo(c,"remove",b),c._modelSharingEnabled=!0)};var u=function(a,b,c,d){function e(a,b,c){function d(a){return b.get(a)||c[a]}return _.map(a,d)}if(!c.silent&&!c._silentLocally){var f,g=a.selectedLength,h=a.length,j=_.keys(b),k=_.keys(a.selected),m=_.difference(k,j),n=_.difference(j,k),o=g===j.length&&0===m.length&&0===n.length;if(d&&d.length&&!c._silentReselect&&l(c,a,["reselect:any",d,a,i(c)]),!o)return f={selected:e(m,a,b),deselected:e(n,a,b)},g===h?void l(c,a,["select:all",f,a,i(c)]):0===g?void l(c,a,["select:none",f,a,i(c)]):g>0&&h>g?void l(c,a,["select:some",f,a,i(c)]):void 0}};Backbone.Select=t}(Backbone,_),Backbone.Select});
//# sourceMappingURL=backbone.select.min.map