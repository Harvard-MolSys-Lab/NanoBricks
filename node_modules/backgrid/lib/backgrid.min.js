/*!
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors <wyuenho@gmail.com>
  Licensed under the MIT license.
*/
!function(a){if("object"==typeof exports){var b={};a(b,require("underscore"),require("jquery2"),require("backbone")),module.exports=b.Backgrid}else"undefined"!=typeof _&&"undefined"!=typeof Backbone&&a(window,_,jQuery,Backbone)}(function(a,b,c,d){"use strict";function e(a,b,c){var d=b-(a+"").length;d=0>d?0:d;for(var e="",f=0;d>f;f++)e+=c;return e+a}var f="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||f.trim()){f="["+f+"]";var g=new RegExp("^"+f+f+"*"),h=new RegExp(f+f+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(g,"").replace(h,"")}}var i=a.Backgrid={VERSION:"0.3.0",Extension:{},requireOptions:function(a,c){for(var d=0;d<c.length;d++){var e=c[d];if(b.isUndefined(a[e]))throw new TypeError("'"+e+"' is required")}},resolveNameToClass:function(a,c){if(b.isString(a)){var d=b.map(a.split("-"),function(a){return a.slice(0,1).toUpperCase()+a.slice(1)}).join("")+c,e=i[d]||i.Extension[d];if(b.isUndefined(e))throw new ReferenceError("Class '"+d+"' not found");return e}return a},callByNeed:function(){var a=arguments[0];if(!b.isFunction(a))return a;var c=arguments[1],d=[].slice.call(arguments,2);return a.apply(c,d+""?d:void 0)}};b.extend(i,d.Events);var j=i.Command=function(a){b.extend(this,{altKey:!!a.altKey,"char":a["char"],charCode:a.charCode,ctrlKey:!!a.ctrlKey,key:a.key,keyCode:a.keyCode,locale:a.locale,location:a.location,metaKey:!!a.metaKey,repeat:!!a.repeat,shiftKey:!!a.shiftKey,which:a.which})};b.extend(j.prototype,{moveUp:function(){return 38==this.keyCode},moveDown:function(){return 40===this.keyCode},moveLeft:function(){return this.shiftKey&&9===this.keyCode},moveRight:function(){return!this.shiftKey&&9===this.keyCode},save:function(){return 13===this.keyCode},cancel:function(){return 27===this.keyCode},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var k=i.CellFormatter=function(){};b.extend(k.prototype,{fromRaw:function(a){return a},toRaw:function(a){return a}});var l=i.NumberFormatter=function(a){if(a=a?b.clone(a):{},b.extend(this,this.defaults,a),this.decimals<0||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};l.prototype=new k,b.extend(l.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(a){if(b.isNull(a)||b.isUndefined(a))return"";a=a.toFixed(~~this.decimals);var c=a.split("."),d=c[0],e=c[1]?(this.decimalSeparator||".")+c[1]:"";return d.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+e},toRaw:function(a){if(a=a.trim(),""===a)return null;for(var c="",d=a.split(this.orderSeparator),e=0;e<d.length;e++)c+=d[e];var f=c.split(this.decimalSeparator);c="";for(var e=0;e<f.length;e++)c=c+f[e]+".";"."===c[c.length-1]&&(c=c.slice(0,c.length-1));var g=1*(1*c).toFixed(~~this.decimals);return b.isNumber(g)&&!b.isNaN(g)?g:void 0}});var m=i.DatetimeFormatter=function(a){if(a=a?b.clone(a):{},b.extend(this,this.defaults,a),!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};m.prototype=new k,b.extend(m.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(a,c){if(""===(a+"").trim())return null;var d,f=null;if(b.isNumber(a)){var g=new Date(a);d=e(g.getUTCFullYear(),4,0)+"-"+e(g.getUTCMonth()+1,2,0)+"-"+e(g.getUTCDate(),2,0),f=e(g.getUTCHours(),2,0)+":"+e(g.getUTCMinutes(),2,0)+":"+e(g.getUTCSeconds(),2,0)}else{a=a.trim();var h=a.split(this.ISO_SPLITTER_RE)||[];d=this.DATE_RE.test(h[0])?h[0]:"",f=d&&h[1]?h[1]:this.TIME_RE.test(h[0])?h[0]:""}var i=this.DATE_RE.exec(d)||[],j=this.TIME_RE.exec(f)||[];if(c){if(this.includeDate&&b.isUndefined(i[0]))return;if(this.includeTime&&b.isUndefined(j[0]))return;if(!this.includeDate&&d)return;if(!this.includeTime&&f)return}var g=new Date(Date.UTC(1*i[1]||0,1*i[2]-1||0,1*i[3]||0,1*j[1]||null,1*j[2]||null,1*j[3]||null,1*j[5]||null)),k="";return this.includeDate&&(k=e(g.getUTCFullYear(),4,0)+"-"+e(g.getUTCMonth()+1,2,0)+"-"+e(g.getUTCDate(),2,0)),this.includeTime&&(k=k+(this.includeDate?"T":"")+e(g.getUTCHours(),2,0)+":"+e(g.getUTCMinutes(),2,0)+":"+e(g.getUTCSeconds(),2,0),this.includeMilli&&(k=k+"."+e(g.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(k+="Z"),k},fromRaw:function(a){return b.isNull(a)||b.isUndefined(a)?"":this._convert(a)},toRaw:function(a){return this._convert(a,!0)}});var n=i.StringFormatter=function(){};n.prototype=new k,b.extend(n.prototype,{fromRaw:function(a){return b.isUndefined(a)||b.isNull(a)?"":a+""}});var o=i.EmailFormatter=function(){};o.prototype=new k,b.extend(o.prototype,{toRaw:function(a){var c=a.trim().split("@");return 2===c.length&&b.all(c)?a:void 0}});var p=i.SelectFormatter=function(){};p.prototype=new k,b.extend(p.prototype,{fromRaw:function(a){return b.isArray(a)?a:null!=a?[a]:[]}});var q=i.CellEditor=d.View.extend({initialize:function(a){i.requireOptions(a,["formatter","column","model"]),this.formatter=a.formatter,this.column=a.column,this.column instanceof y||(this.column=new y(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(a,b){return(null==b||b.get("name")==this.column.get("name"))&&this.$el.focus(),this}}),r=i.InputCellEditor=q.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(a){q.prototype.initialize.apply(this,arguments),a.placeholder&&this.$el.attr("placeholder",a.placeholder)},render:function(){return this.$el.val(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},saveOrCancel:function(a){var c=this.formatter,d=this.model,e=this.column,f=new j(a),g="blur"===a.type;if(f.moveUp()||f.moveDown()||f.moveLeft()||f.moveRight()||f.save()||g){a.preventDefault(),a.stopPropagation();var h=this.$el.val(),i=c.toRaw(h);b.isUndefined(i)?d.trigger("backgrid:error",d,e,h):(d.set(e.get("name"),i),d.trigger("backgrid:edited",d,e,f))}else f.cancel()&&(a.stopPropagation(),d.trigger("backgrid:edited",d,e,f))},postRender:function(a,b){if(null==b||b.get("name")==this.column.get("name"))if("right"===this.$el.css("text-align")){var c=this.$el.val();this.$el.focus().val(null).val(c)}else this.$el.focus();return this}}),s=i.Cell=d.View.extend({tagName:"td",formatter:new k,editor:r,events:{click:"enterEditMode"},initialize:function(a){i.requireOptions(a,["model","column"]),this.column=a.column,this.column instanceof y||(this.column=new y(this.column));var b=this.column,c=this.model,d=this.$el;this.formatter=i.resolveNameToClass(b.get("formatter")||this.formatter,"Formatter"),this.editor=i.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(c,"change:"+b.get("name"),function(){d.hasClass("editor")||this.render()}),this.listenTo(c,"backgrid:error",this.renderError),this.listenTo(b,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var c in b)b.hasOwnProperty(c)&&d.toggleClass(c,b[c])}),b.get("editable")&&d.addClass("editable"),b.get("sortable")&&d.addClass("sortable"),b.get("renderable")&&d.addClass("renderable")},render:function(){return this.$el.empty(),this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.delegateEvents(),this},enterEditMode:function(){var a=this.model,b=this.column,c=i.callByNeed(b.editable(),b,a);c&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),a.trigger("backgrid:edit",a,b,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),a.trigger("backgrid:editing",a,b,this,this.currentEditor))},renderError:function(a,b){(null==b||b.get("name")==this.column.get("name"))&&this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),d.View.prototype.remove.apply(this,arguments)}}),t=i.StringCell=s.extend({className:"string-cell",formatter:new n});i.UriCell=s.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(a){s.prototype.initialize.apply(this,arguments),this.title=a.title||this.title,this.target=a.target||this.target},render:function(){this.$el.empty();var a=this.model.get(this.column.get("name")),b=this.formatter.fromRaw(a);return this.$el.append(c("<a>",{tabIndex:-1,href:a,title:this.title||b,target:this.target}).text(b)),this.delegateEvents(),this}}),i.EmailCell=t.extend({className:"email-cell",formatter:new o,render:function(){this.$el.empty();var a=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(c("<a>",{tabIndex:-1,href:"mailto:"+a,title:a}).text(a)),this.delegateEvents(),this}});var u=i.NumberCell=s.extend({className:"number-cell",decimals:l.prototype.defaults.decimals,decimalSeparator:l.prototype.defaults.decimalSeparator,orderSeparator:l.prototype.defaults.orderSeparator,formatter:l,initialize:function(){s.prototype.initialize.apply(this,arguments),this.formatter.fromRaw||this.formatter.toRaw||(this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator}))}});i.IntegerCell=u.extend({className:"integer-cell",decimals:0});var v=i.DatetimeCell=s.extend({className:"datetime-cell",includeDate:m.prototype.defaults.includeDate,includeTime:m.prototype.defaults.includeTime,includeMilli:m.prototype.defaults.includeMilli,formatter:m,initialize:function(){s.prototype.initialize.apply(this,arguments),this.formatter.fromRaw||this.formatter.toRaw||(this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli}));var a=this.includeDate?"YYYY-MM-DD":"";a+=this.includeDate&&this.includeTime?"T":"",a+=this.includeTime?"HH:mm:ss":"",a+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:b.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:a})})}});i.DateCell=v.extend({className:"date-cell",includeTime:!1}),i.TimeCell=v.extend({className:"time-cell",includeDate:!1});var w=i.BooleanCellEditor=q.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var a=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.prop("checked",a),this},enterOrExitEditMode:function(a){if(!this.mouseDown){var b=this.model;b.trigger("backgrid:edited",b,this.column,new j(a))}},saveOrCancel:function(a){var b=this.model,c=this.column,d=this.formatter,e=new j(a);if(e.passThru()&&"change"!=a.type)return!0;e.cancel()&&(a.stopPropagation(),b.trigger("backgrid:edited",b,c,e));var f=this.$el;if(e.save()||e.moveLeft()||e.moveRight()||e.moveUp()||e.moveDown()){a.preventDefault(),a.stopPropagation();var g=d.toRaw(f.prop("checked"));b.set(c.get("name"),g),b.trigger("backgrid:edited",b,c,e)}else if("change"==a.type){var g=d.toRaw(f.prop("checked"));b.set(c.get("name"),g),f.focus()}}});i.BooleanCell=s.extend({className:"boolean-cell",editor:w,events:{click:"enterEditMode"},render:function(){return this.$el.empty(),this.$el.append(c("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(this.model.get(this.column.get("name")))})),this.delegateEvents(),this}});var x=i.SelectCellEditor=q.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:b.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>'),setOptionValues:function(a){this.optionValues=a},setMultiple:function(a){this.multiple=a,this.$el.prop("multiple",a)},_renderOptions:function(a,b){for(var c="",d=0;d<a.length;d++)c+=this.template({text:a[d][0],value:a[d][1],selected:b.indexOf(a[d][1])>-1});return c},render:function(){this.$el.empty();var a=b.result(this,"optionValues"),d=this.formatter.fromRaw(this.model.get(this.column.get("name")));if(!b.isArray(a))throw new TypeError("optionValues must be an array");for(var e=null,f=null,e=null,g=null,h=null,i=0;i<a.length;i++){var e=a[i];if(b.isArray(e))f=e[0],e=e[1],this.$el.append(this.template({text:f,value:e,selected:d.indexOf(e)>-1}));else{if(!b.isObject(e))throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");g=e.name,h=c("<optgroup></optgroup>",{label:g}),h.append(this._renderOptions(e.values,d)),this.$el.append(h)}}return this.delegateEvents(),this},save:function(a){var b=this.model,c=this.column;b.set(c.get("name"),this.formatter.toRaw(this.$el.val())),b.trigger("backgrid:edited",b,c,new j(a))},close:function(a){var b=this.model,c=this.column,d=new j(a);d.cancel()?(a.stopPropagation(),b.trigger("backgrid:edited",b,c,new j(a))):(d.save()||d.moveLeft()||d.moveRight()||d.moveUp()||d.moveDown()||"blur"==a.type)&&(a.preventDefault(),a.stopPropagation(),"blur"==a.type&&1===this.$el.find("option").length&&b.set(c.get("name"),this.formatter.toRaw(this.$el.val())),b.trigger("backgrid:edited",b,c,new j(a)))}});i.SelectCell=s.extend({className:"select-cell",editor:x,multiple:!1,formatter:new p,optionValues:void 0,delimiter:", ",initialize:function(){s.prototype.initialize.apply(this,arguments),i.requireOptions(this,["optionValues"]),this.listenTo(this.model,"backgrid:edit",function(a,b,c,d){b.get("name")==this.column.get("name")&&(d.setOptionValues(this.optionValues),d.setMultiple(this.multiple))})},render:function(){this.$el.empty();var a=this.optionValues,c=this.formatter.fromRaw(this.model.get(this.column.get("name"))),d=[];try{if(!b.isArray(a)||b.isEmpty(a))throw new TypeError;for(var e=0;e<c.length;e++)for(var f=c[e],g=0;g<a.length;g++){var h=a[g];if(b.isArray(h)){var i=h[0],h=h[1];h==f&&d.push(i)}else{if(!b.isObject(h))throw new TypeError;for(var j=h.values,k=0;k<j.length;k++){var l=j[k];l[1]==f&&d.push(l[0])}}}this.$el.append(d.join(this.delimiter))}catch(m){if(m instanceof TypeError)throw new TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw m}return this.delegateEvents(),this}});var y=i.Column=d.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,sortValue:void 0,cell:void 0,headerCell:void 0},initialize:function(a){i.requireOptions(a,["cell","name"]),this.has("label")||this.set({label:this.get("name")},{silent:!0});var b=i.resolveNameToClass(this.get("headerCell"),"HeaderCell"),c=i.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:c,headerCell:b},{silent:!0})},sortValue:function(){var a=this.get("sortValue");return b.isString(a)?this[a]:b.isFunction(a)?a:function(a,b){return a.get(b)}}});b.each(["sortable","renderable","editable"],function(a){y.prototype[a]=function(){var c=this.get(a);return b.isString(c)?this[c]:!!c}});var z=i.Columns=d.Collection.extend({model:y}),A=i.Row=d.View.extend({tagName:"tr",requiredOptions:["columns","model"],initialize:function(a){i.requireOptions(a,this.requiredOptions);var b=this.columns=a.columns;b instanceof d.Collection||(b=this.columns=new z(b));for(var c=this.cells=[],e=0;e<b.length;e++)c.push(this.makeCell(b.at(e),a));this.listenTo(b,"add",function(b,d){var e=d.indexOf(b),f=this.makeCell(b,a);c.splice(e,0,f);var g=this.$el;0===e?g.prepend(f.render().$el):e===d.length-1?g.append(f.render().$el):g.children().eq(e).before(f.render().$el)}),this.listenTo(b,"remove",function(a,b,d){c[d.index].remove(),c.splice(d.index,1)})},makeCell:function(a){return new(a.get("cell"))({column:a,model:this.model})},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.cells.length;b++)a.appendChild(this.cells[b].render().el);return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.cells.length;a++){var b=this.cells[a];b.remove.apply(b,arguments)}return d.View.prototype.remove.apply(this,arguments)}}),B=i.EmptyRow=d.View.extend({tagName:"tr",emptyText:null,initialize:function(a){i.requireOptions(a,["emptyText","columns"]),this.emptyText=a.emptyText,this.columns=a.columns},render:function(){this.$el.empty();var a=document.createElement("td");return a.setAttribute("colspan",this.columns.length),a.textContent=this.emptyText,this.el.setAttribute("class","empty"),this.el.appendChild(a),this}}),C=i.HeaderCell=d.View.extend({tagName:"th",events:{"click a":"onClick"},_direction:null,initialize:function(a){i.requireOptions(a,["column","collection"]),this.column=a.column,this.column instanceof y||(this.column=new y(this.column)),this.listenTo(this.collection,"backgrid:sort",this._resetCellDirection);var b=this.column,c=this.$el;this.listenTo(b,"change:editable change:sortable change:renderable",function(a){var b=a.changedAttributes();for(var d in b)b.hasOwnProperty(d)&&c.toggleClass(d,b[d])}),b.get("editable")&&c.addClass("editable"),b.get("sortable")&&c.addClass("sortable"),b.get("renderable")&&c.addClass("renderable")},direction:function(a){return arguments.length&&(this._direction&&this.$el.removeClass(this._direction),a&&this.$el.addClass(a),this._direction=a),this._direction},_resetCellDirection:function(a,b,c,d){d==this.collection&&(a!==this.column?this.direction(null):this.direction(b))},onClick:function(a){function b(a,b){"ascending"===a.direction()?a.sort(b,"descending"):"descending"===a.direction()?a.sort(b,null):a.sort(b,"ascending")}function c(a,b){"ascending"===a.direction()?a.sort(b,"descending"):a.sort(b,"ascending")}a.preventDefault();var d=this.column,e=i.callByNeed(d.sortable(),d,this.model);if(e){var f=d.get("sortType");"toggle"===f?c(this,d):b(this,d)}},sort:function(a,b){var c,e=this.collection;c="ascending"===b?-1:"descending"===b?1:null;var f=this.makeComparator(a.get("name"),c,c?a.sortValue():function(a){return a.cid});d.PageableCollection&&e instanceof d.PageableCollection?(e.setSorting(c&&a.get("name"),c,{sortValue:a.sortValue()}),"client"==e.mode?(null==e.fullCollection.comparator&&(e.fullCollection.comparator=f),e.fullCollection.sort()):e.fetch({reset:!0})):(e.comparator=f,e.sort()),this.collection.trigger("backgrid:sort",a,b,f,this.collection)},makeComparator:function(a,b,c){return function(d,e){var f,g=c(d,a),h=c(e,a);return 1===b&&(f=g,g=h,h=f),g===h?0:h>g?-1:1}},render:function(){this.$el.empty();var a=c("<a>").text(this.column.get("label")),b=i.callByNeed(this.column.sortable(),this.column,this.model);return b&&a.append("<b class='sort-caret'></b>"),this.$el.append(a),this.delegateEvents(),this}});i.HeaderRow=i.Row.extend({requiredOptions:["columns","collection"],initialize:function(){i.Row.prototype.initialize.apply(this,arguments)},makeCell:function(a,b){var c=a.get("headerCell")||b.headerCell||C;return c=new c({column:a,collection:this.collection})}});var D=i.Header=d.View.extend({tagName:"thead",initialize:function(a){i.requireOptions(a,["columns","collection"]),this.columns=a.columns,this.columns instanceof d.Collection||(this.columns=new z(this.columns)),this.row=new i.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),d.View.prototype.remove.apply(this,arguments)}}),E=i.Body=d.View.extend({tagName:"tbody",initialize:function(a){i.requireOptions(a,["columns","collection"]),this.columns=a.columns,this.columns instanceof d.Collection||(this.columns=new z(this.columns)),this.row=a.row||A,this.rows=this.collection.map(function(a){var b=new this.row({columns:this.columns,model:a});return b},this),this.emptyText=a.emptyText,this._unshiftEmptyRowMayBe();var b=this.collection;this.listenTo(b,"add",this.insertRow),this.listenTo(b,"remove",this.removeRow),this.listenTo(b,"sort",this.refresh),this.listenTo(b,"reset",this.refresh),this.listenTo(b,"backgrid:edited",this.moveToNextCell)},_unshiftEmptyRowMayBe:function(){0===this.rows.length&&null!=this.emptyText&&this.rows.unshift(new B({emptyText:this.emptyText,columns:this.columns}))},insertRow:function(a,c,e){if(this.rows[0]instanceof B&&this.rows.pop().remove(),!(c instanceof d.Collection||e))return this.collection.add(a,e=c),void 0;e=b.extend({render:!0},e||{});var f=new this.row({columns:this.columns,model:a}),g=c.indexOf(a);this.rows.splice(g,0,f);var h=this.$el,i=h.children(),j=f.render().$el;e.render&&(g>=i.length?h.append(j):i.eq(g).before(j))},removeRow:function(a,c,d){return d?((b.isUndefined(d.render)||d.render)&&this.rows[d.index].remove(),this.rows.splice(d.index,1),this._unshiftEmptyRowMayBe(),void 0):(this.collection.remove(a,d=c),this._unshiftEmptyRowMayBe(),void 0)},refresh:function(){for(var a=0;a<this.rows.length;a++)this.rows[a].remove();return this.rows=this.collection.map(function(a){var b=new this.row({columns:this.columns,model:a});return b},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.rows.length;b++){var c=this.rows[b];a.appendChild(c.render().el)}return this.el.appendChild(a),this.delegateEvents(),this},remove:function(){for(var a=0;a<this.rows.length;a++){var b=this.rows[a];b.remove.apply(b,arguments)}return d.View.prototype.remove.apply(this,arguments)},moveToNextCell:function(a,b,c){var d,e,f,g=this.collection.indexOf(a),h=this.columns.indexOf(b);if(this.rows[g].cells[h].exitEditMode(),c.moveUp()||c.moveDown()||c.moveLeft()||c.moveRight()||c.save()){var j=this.columns.length,k=j*this.collection.length;if(c.moveUp()||c.moveDown()){var l=this.rows[g+(c.moveUp()?-1:1)];l&&(d=l.cells[h],i.callByNeed(d.column.editable(),d.column,a)&&d.enterEditMode())}else if(c.moveLeft()||c.moveRight())for(var m=c.moveRight(),n=g*j+h+(m?1:-1);n>=0&&k>n;m?n++:n--){var o=~~(n/j),p=n-o*j;if(d=this.rows[o].cells[p],e=i.callByNeed(d.column.renderable(),d.column,d.model),f=i.callByNeed(d.column.editable(),d.column,a),e&&f){d.enterEditMode();break}}}}});i.Footer=d.View.extend({tagName:"tfoot",initialize:function(a){i.requireOptions(a,["columns","collection"]),this.columns=a.columns,this.columns instanceof d.Collection||(this.columns=new i.Columns(this.columns))}}),i.Grid=d.View.extend({tagName:"table",className:"backgrid",header:D,body:E,footer:null,initialize:function(a){i.requireOptions(a,["columns","collection"]),a.columns instanceof d.Collection||(a.columns=new z(a.columns)),this.columns=a.columns;var c=b.omit(a,["el","id","attributes","className","tagName","events"]);this.header=a.header||this.header,this.header=new this.header(c),this.body=a.body||this.body,this.body=new this.body(c),this.footer=a.footer||this.footer,this.footer&&(this.footer=new this.footer(c)),this.listenTo(this.columns,"reset",function(){this.header=new(this.header.remove().constructor)(c),this.body=new(this.body.remove().constructor)(c),this.footer&&(this.footer=new(this.footer.remove().constructor)(c)),this.render()})},insertRow:function(a,b,c){return this.body.insertRow(a,b,c)},removeRow:function(a,b,c){return this.body.removeRow(a,b,c)},insertColumn:function(a,b){return b=b||{render:!0},this.columns.add(a,b),this},removeColumn:function(a,b){return this.columns.remove(a,b),this},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),d.View.prototype.remove.apply(this,arguments)}})});